---
title: GC老年代回收
date: 2023-09-08 10:59:40
permalink: /pages/2c631b/
---



# 一、支付反馈导致主播运营平台不可用
## 1.1.背景
每周五财务出纳会统一支付礼物订单，支付完之后会进行状态同步，数量5w+，将状态同步至（MQ）主播运营管理平台；


## 1.2.环境
主播运营平台部署在老板机器，相关监控不是很完善

## 1.3.问题
每次支付反馈时有大量告警，主播服务不可用，且影响其他依赖主播接口的服务告警

## 1.4.解决思路及过程
- 1.主播同步支付状态逻辑并不复杂，首先查看是否有慢查询，查看**调用链**，发现根据经纪公司名称获取经纪公司信息耗时较长，怀疑没索引，查看线上表结果，果然没索引，加上索引解决

- 2. 过一段时间支付反馈时仍然偶尔告警，严重时服务不可用

- 3.怀疑仍然有慢查询，排查未果

- 4 查看打印的JVM日志，发现频繁old gc，怀疑有大对象
![img.png](/img/study/jvm01.png)

- 5.仔细排查代码，发现有一个异步逻辑，更新对账单核销状态，sql本身没问题，单更新逻辑有问题：在一个对账单包含很多订单的情况下，订单同时进行支付并回传支付状态，短时间内会产生大量**大对象**。例如一个对账单包含5000个订单，会进行5000次查询，每次查询5000个订单，会导致对象直接转移到老年代，触发GC
![img_1.png](/img/study/jvm02.png)
![img_2.png](/img/study/jvm03.png)

- 6.优化业务逻辑，查询是否有未付款的订单，如果不存在，更新对账单状态为已核销



## 1.5.总结
- 写sql一定要注意运行效率
- 业务场景不能简单化，选用最合适的逻辑；不能偷懒随便复用代码逻辑


# 二、前置订单处理JOB频繁卡住
## 1.1.背景
结算中台同步订单后，会暂存到一张前置表，通过定时任务异步批量处理

## 1.2.问题
定时任务经常卡住，导致订单处理暂停，影响订单结算，需要重启服务才能恢复正常，持续时间较久

## 1.3.解决思路及过程

- 1.联想到每次重启服务恢复正常，且订单处理过程中为加快处理效率，组装主播信息时使用了多线程处理，怀疑线程数量过多导致线程竞争，查看JVM日志发现线程数量确实有上升，所以临时改为单线程处理查看效果。上线后问题仍然存在

- 2. 再度检查慢查询

- 3.增加日志，查看卡住节点，发现是调用房间信息接口时（外部接口）卡住，且一直hang住。现象比较奇怪，并不是所有的接口调用都失败，是循环调用接口时，忽然卡住，无任何日志，联系张明可协助排查，排除接口问题，怀疑是脏节点问题，导致一直connect，对比初始化节点和当前节点，发现果然存在脏节点（调用GRPC接口共性问题）。先加上节点连接信息临时重启，脏节点问题推进待解决


## 1.4.总结
- 系统间交互做统一异常、日志、超时管理，方便排查问题